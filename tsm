#!/bin/bash
# TSM - Tmux Session Manager v2.2.2

TSM_ROOT="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
export TSM_ROOT
TSM_VERSION="2.2.2"

source "$TSM_ROOT/lib/utils.sh"
source "$TSM_ROOT/lib/config.sh"
source "$TSM_ROOT/lib/lang.sh"
source "$TSM_ROOT/lib/core.sh"
source "$TSM_ROOT/lib/menu.sh"

init() {
    check_tmux || { echo "Hata: tmux kurulu deÄŸil"; exit 1; }
    setup_cleanup
    check_terminal
    check_connection
    config_init
    lang_load "$(config_get language)"
    local theme="$(config_get theme)"
    [[ "$HAS_EMOJI" == "false" ]] && [[ "$theme" == "default" ]] && theme="minimal"
    source "$TSM_ROOT/themes/$theme.sh"
}

# Ana menÃ¼ oluÅŸtur
build_main_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    
    # Son oturum (varsa en Ã¼stte)
    local last=$(get_last_session)
    if [[ -n "$last" ]] && tmux has-session -t "$last" 2>/dev/null; then
        MENU_ITEMS+=("âš¡ Son Oturum: $last")
        MENU_ACTIONS+=("do_attach|$last")
    fi
    
    # Yeni oturum
    MENU_ITEMS+=("âž• Yeni Oturum")
    MENU_ACTIONS+=("do_new_session")
    
    # TÃœM oturumlar (son oturum dahil)
    local sessions=$(sessions_list)
    if [[ -n "$sessions" ]]; then
        while IFS='|' read -r name windows attached created; do
            local icon="âšª"
            [[ "$attached" == "1" ]] && icon="ðŸŸ¢"
            MENU_ITEMS+=("ðŸ“‚ $name ($windows win) $icon")
            MENU_ACTIONS+=("do_session_menu|$name")
        done <<< "$sessions"
    fi
    
    MENU_ITEMS+=("âš™ï¸  Ayarlar")
    MENU_ACTIONS+=("do_settings")
    
    MENU_ITEMS+=("ðŸšª Ã‡Ä±kÄ±ÅŸ")
    MENU_ACTIONS+=("do_exit")
}

do_new_session() {
    input_dialog "Oturum adÄ±"
    local name="$INPUT_RESULT"
    
    [[ -z "$name" ]] && { main_menu; return; }
    
    if ! validate_session_name "$name"; then
        show_message error "GeÃ§ersiz isim"
        sleep 1
        main_menu
        return
    fi
    
    show_loading "OluÅŸturuluyor..."
    if session_create "$name"; then
        clear_loading
        show_message success "'$name' oluÅŸturuldu"
        save_last_session "$name"
        sleep 1
        do_attach "$name"
    else
        clear_loading
        show_message error "OluÅŸturulamadÄ±"
        sleep 1
        main_menu
    fi
}

do_attach() {
    local name="$1"
    reset_terminal
    save_last_session "$name"
    
    if is_in_tmux; then
        tmux switch-client -t "$name"
    else
        tmux attach-session -t "$name"
        [[ -n "$SSH_CONNECTION" ]] && exec tsm
    fi
}

do_session_menu() {
    local sname="$1"
    
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="ðŸ“‚ $sname"
    MENU_SELECTED=0
    
    MENU_ITEMS+=("â–¶ï¸  BaÄŸlan")
    MENU_ACTIONS+=("do_attach|$sname")
    
    local wins=$(tmux list-windows -t "$sname" -F '#{window_index}:#{window_name}:#{window_active}' 2>/dev/null)
    if [[ -n "$wins" ]]; then
        MENU_ITEMS+=("â”€â”€ Pencereler â”€â”€")
        MENU_ACTIONS+=("do_session_menu|$sname")
        
        while IFS=':' read -r idx wname active; do
            local mark="  "
            [[ "$active" == "1" ]] && mark="â–¸ "
            MENU_ITEMS+=("${mark}$idx: $wname")
            MENU_ACTIONS+=("do_attach_window|$sname|$idx")
        done <<< "$wins"
    fi
    
    MENU_ITEMS+=("âž• Yeni Pencere")
    MENU_ACTIONS+=("do_new_window|$sname")
    
    MENU_ITEMS+=("âœï¸  Yeniden AdlandÄ±r")
    MENU_ACTIONS+=("do_rename|$sname")
    
    MENU_ITEMS+=("ðŸ—‘ï¸  Sil")
    MENU_ACTIONS+=("do_delete|$sname")
    
    MENU_ITEMS+=("â† Geri")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    handle_result
}

do_attach_window() {
    local sname="$1" widx="$2"
    tmux select-window -t "$sname:$widx" 2>/dev/null
    do_attach "$sname"
}

do_new_window() {
    local sname="$1"
    input_dialog "Pencere adÄ± (boÅŸ olabilir)"
    local wname="$INPUT_RESULT"
    
    show_loading "OluÅŸturuluyor..."
    [[ -n "$wname" ]] && tmux new-window -t "$sname" -n "$wname" || tmux new-window -t "$sname"
    clear_loading
    show_message success "Pencere oluÅŸturuldu"
    sleep 1
    do_session_menu "$sname"
}

do_rename() {
    local old="$1"
    input_dialog "Yeni isim" "$old"
    local new="$INPUT_RESULT"
    
    [[ -z "$new" || "$new" == "$old" ]] && { do_session_menu "$old"; return; }
    
    if ! validate_session_name "$new"; then
        show_message error "GeÃ§ersiz isim"
        sleep 1
        do_session_menu "$old"
        return
    fi
    
    if session_rename "$old" "$new"; then
        show_message success "AdÄ± '$new' olarak deÄŸiÅŸtirildi"
        [[ "$(get_last_session)" == "$old" ]] && save_last_session "$new"
    else
        show_message error "DeÄŸiÅŸtirilemedi"
    fi
    sleep 1
    main_menu
}

do_delete() {
    local sname="$1"
    if confirm_dialog "'$sname' silinsin mi?"; then
        show_loading "Siliniyor..."
        if session_delete "$sname"; then
            clear_loading
            show_message success "Silindi"
            [[ "$(get_last_session)" == "$sname" ]] && save_last_session ""
        else
            clear_loading
            show_message error "Silinemedi"
        fi
    fi
    sleep 1
    main_menu
}

do_settings() {
    MENU_ITEMS=("ðŸŒ Dil: $(config_get language)" "ðŸŽ¨ Tema: $(config_get theme)" "ðŸ“‹ Tmux Config Uygula" "â† Geri")
    MENU_ACTIONS=("do_lang" "do_theme" "do_apply_config" "main_menu")
    MENU_TITLE="âš™ï¸ Ayarlar"
    MENU_SELECTED=0
    menu_loop
    handle_result
}

do_lang() {
    MENU_ITEMS=("ðŸŒ Auto" "ðŸ‡¬ðŸ‡§ English" "ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e" "â† Geri")
    MENU_ACTIONS=("set_lang|auto" "set_lang|en" "set_lang|tr" "do_settings")
    MENU_TITLE="ðŸŒ Dil"
    MENU_SELECTED=0
    menu_loop
    handle_result
}

set_lang() {
    config_set language "$1"
    config_save
    lang_load "$1"
    show_message success "Dil deÄŸiÅŸtirildi"
    sleep 1
    do_settings
}

do_theme() {
    MENU_ITEMS=("ðŸŽ¨ Default" "ï¿½ï¿½ Minimal" "â† Geri")
    MENU_ACTIONS=("set_theme|default" "set_theme|minimal" "do_settings")
    MENU_TITLE="ðŸŽ¨ Tema"
    MENU_SELECTED=0
    menu_loop
    handle_result
}

set_theme() {
    config_set theme "$1"
    config_save
    source "$TSM_ROOT/themes/$1.sh"
    show_message success "Tema deÄŸiÅŸtirildi"
    sleep 1
    do_settings
}

do_apply_config() {
    show_loading "UygulanÄ±yor..."
    cat > ~/.tmux.conf << 'TCFG'
set -g history-limit 50000
set -g mouse on
setw -g mode-keys vi
set -sg escape-time 0
set -g base-index 1
set -g renumber-windows on
set -g status-position bottom
set -g status-style 'bg=#1e1e2e fg=#cdd6f4'
set -g status-left '#[bg=#89b4fa,fg=#1e1e2e,bold] #S '
set -g status-right-length 100
set -g status-right '#[fg=#89b4fa][ #[fg=#a6e3a1]c#[fg=#6c7086]:Yeni #[fg=#a6e3a1]d#[fg=#6c7086]:Detach #[fg=#a6e3a1]T#[fg=#6c7086]:TSM #[fg=#89b4fa]] #[fg=white]%H:%M'
setw -g window-status-format '#[fg=#6c7086] #I:#W '
setw -g window-status-current-format '#[bg=#a6e3a1,fg=#1e1e2e,bold] #I:#W '
bind-key T run-shell 'tmux detach -E tsm'
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind u copy-mode
TCFG
    tmux source-file ~/.tmux.conf 2>/dev/null
    clear_loading
    show_message success "Config uygulandÄ±"
    sleep 1
    do_settings
}

do_exit() {
    reset_terminal
    clear_screen
    exit 0
}

handle_result() {
    local sel=$MENU_RESULT
    [[ $sel -eq 255 ]] && { main_menu; return; }
    [[ $sel -lt ${#MENU_ACTIONS[@]} ]] || { main_menu; return; }
    local action="${MENU_ACTIONS[$sel]}"
    IFS='|' read -r func arg1 arg2 <<< "$action"
    [[ -n "$func" ]] && $func "$arg1" "$arg2"
}

main_menu() {
    MENU_TITLE="ðŸ–¥ï¸  TSM - Session Manager"
    MENU_SELECTED=0
    MENU_RESULT=255
    build_main_menu
    menu_loop
    handle_result
}

show_help() { cat << EOF
TSM v${TSM_VERSION}
KullanÄ±m: tsm [-h] [-v] [-l] [-n AD] [-a]
EOF
}

main() {
    case "${1:-}" in
        -h|--help) show_help; exit 0 ;;
        -v|--version) echo "TSM v$TSM_VERSION"; exit 0 ;;
        -l|--list) sessions_list | while IFS='|' read -r n w a c; do echo "$n ($w win)"; done; exit 0 ;;
        -n|--new) [[ -n "$2" ]] && { session_create "$2"; tmux attach -t "$2"; } || echo "tsm -n AD"; exit 0 ;;
        -a|--attach) 
            local s=$(get_last_session)
            [[ -n "$s" ]] && tmux has -t "$s" 2>/dev/null && tmux attach -t "$s" && exit 0
            s=$(tmux ls -F '#{session_name}' 2>/dev/null | head -1)
            [[ -n "$s" ]] && tmux attach -t "$s" || echo "Oturum yok"
            exit 0 ;;
    esac
    init
    main_menu
}

main "$@"

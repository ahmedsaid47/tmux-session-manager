#!/bin/bash
#
# TSM - Tmux Session Manager v2.2.1
# https://github.com/ahmedsaid47/tmux-session-manager
#

TSM_ROOT="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
export TSM_ROOT
TSM_VERSION="2.2.1"

source "$TSM_ROOT/lib/utils.sh"
source "$TSM_ROOT/lib/config.sh"
source "$TSM_ROOT/lib/lang.sh"
source "$TSM_ROOT/lib/core.sh"
source "$TSM_ROOT/lib/menu.sh"

init() {
    if ! check_tmux; then
        echo "Hata: tmux kurulu deÄŸil"
        exit 1
    fi
    
    setup_cleanup
    check_terminal
    check_connection
    config_init
    lang_load "$(config_get language)"
    
    local theme="$(config_get theme)"
    [[ "$HAS_EMOJI" == "false" ]] && [[ "$theme" == "default" ]] && theme="minimal"
    source "$TSM_ROOT/themes/$theme.sh"
}

# Ana menÃ¼ oluÅŸtur
build_main_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    
    # Son oturum
    local last=$(get_last_session)
    if [[ -n "$last" ]] && tmux has-session -t "$last" 2>/dev/null; then
        MENU_ITEMS+=("âš¡ Son: $last")
        MENU_ACTIONS+=("do_attach|$last")
    fi
    
    # Yeni oturum
    MENU_ITEMS+=("âž• Yeni Oturum")
    MENU_ACTIONS+=("do_new_session")
    
    # Oturum listesi
    local sessions=$(sessions_list)
    if [[ -n "$sessions" ]]; then
        while IFS='|' read -r name windows attached created; do
            [[ "$name" == "$last" ]] && continue
            local icon="âšª"
            [[ "$attached" == "1" ]] && icon="ðŸŸ¢"
            MENU_ITEMS+=("ðŸ“‚ $name ($windows win) $icon")
            MENU_ACTIONS+=("do_session_menu|$name")
        done <<< "$sessions"
    fi
    
    MENU_ITEMS+=("âš™ï¸  Ayarlar")
    MENU_ACTIONS+=("do_settings")
    
    MENU_ITEMS+=("ðŸšª Ã‡Ä±kÄ±ÅŸ")
    MENU_ACTIONS+=("do_exit")
}

# Yeni oturum oluÅŸtur
do_new_session() {
    input_dialog "Oturum adÄ±"
    local name="$INPUT_RESULT"
    
    if [[ -z "$name" ]]; then
        main_menu
        return
    fi
    
    if ! validate_session_name "$name"; then
        show_message error "GeÃ§ersiz isim (sadece harf, rakam, _ ve - kullanÄ±n)"
        sleep 1
        main_menu
        return
    fi
    
    show_loading "Oturum oluÅŸturuluyor..."
    
    if session_create "$name"; then
        clear_loading
        show_message success "Oturum '$name' oluÅŸturuldu"
        save_last_session "$name"
        sleep 1
        do_attach "$name"
    else
        clear_loading
        show_message error "Oturum oluÅŸturulamadÄ±"
        sleep 1
        main_menu
    fi
}

# Oturuma baÄŸlan
do_attach() {
    local name="$1"
    reset_terminal
    save_last_session "$name"
    
    if is_in_tmux; then
        tmux switch-client -t "$name"
    else
        tmux attach-session -t "$name"
        # Detach sonrasÄ± TSM'e dÃ¶n
        [[ -n "$SSH_CONNECTION" ]] && exec tsm
    fi
}

# Oturum alt menÃ¼sÃ¼
do_session_menu() {
    local sname="$1"
    
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="ðŸ“‚ $sname"
    MENU_SELECTED=0
    
    MENU_ITEMS+=("â–¶ï¸  BaÄŸlan")
    MENU_ACTIONS+=("do_attach|$sname")
    
    # Pencereler
    local wins=$(tmux list-windows -t "$sname" -F '#{window_index}:#{window_name}:#{window_active}' 2>/dev/null)
    if [[ -n "$wins" ]]; then
        MENU_ITEMS+=("â”€â”€ Pencereler â”€â”€")
        MENU_ACTIONS+=("do_session_menu|$sname")
        
        while IFS=':' read -r idx wname active; do
            local mark="  "
            [[ "$active" == "1" ]] && mark="â–¸ "
            MENU_ITEMS+=("${mark}$idx: $wname")
            MENU_ACTIONS+=("do_attach_window|$sname|$idx")
        done <<< "$wins"
    fi
    
    MENU_ITEMS+=("âž• Yeni Pencere")
    MENU_ACTIONS+=("do_new_window|$sname")
    
    MENU_ITEMS+=("âœï¸  Yeniden AdlandÄ±r")
    MENU_ACTIONS+=("do_rename|$sname")
    
    MENU_ITEMS+=("ðŸ—‘ï¸  Sil")
    MENU_ACTIONS+=("do_delete|$sname")
    
    MENU_ITEMS+=("â† Geri")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    handle_menu_result
}

# Pencereye baÄŸlan
do_attach_window() {
    local sname="$1"
    local widx="$2"
    tmux select-window -t "$sname:$widx" 2>/dev/null
    do_attach "$sname"
}

# Yeni pencere
do_new_window() {
    local sname="$1"
    
    input_dialog "Pencere adÄ± (boÅŸ bÄ±rakÄ±labilir)"
    local wname="$INPUT_RESULT"
    
    show_loading "Pencere oluÅŸturuluyor..."
    
    if [[ -n "$wname" ]]; then
        tmux new-window -t "$sname" -n "$wname"
    else
        tmux new-window -t "$sname"
    fi
    
    clear_loading
    show_message success "Pencere oluÅŸturuldu"
    sleep 1
    do_session_menu "$sname"
}

# Yeniden adlandÄ±r
do_rename() {
    local old="$1"
    
    input_dialog "Yeni isim" "$old"
    local new="$INPUT_RESULT"
    
    if [[ -z "$new" ]] || [[ "$new" == "$old" ]]; then
        do_session_menu "$old"
        return
    fi
    
    if ! validate_session_name "$new"; then
        show_message error "GeÃ§ersiz isim"
        sleep 1
        do_session_menu "$old"
        return
    fi
    
    if session_rename "$old" "$new"; then
        show_message success "Ä°sim deÄŸiÅŸtirildi: $new"
        [[ "$(get_last_session)" == "$old" ]] && save_last_session "$new"
    else
        show_message error "Ä°sim deÄŸiÅŸtirilemedi"
    fi
    sleep 1
    main_menu
}

# Sil
do_delete() {
    local sname="$1"
    
    if confirm_dialog "'$sname' silinsin mi?"; then
        show_loading "Siliniyor..."
        if session_delete "$sname"; then
            clear_loading
            show_message success "Silindi"
            [[ "$(get_last_session)" == "$sname" ]] && save_last_session ""
        else
            clear_loading
            show_message error "Silinemedi"
        fi
    fi
    sleep 1
    main_menu
}

# Ayarlar
do_settings() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="âš™ï¸ Ayarlar"
    MENU_SELECTED=0
    
    MENU_ITEMS+=("ðŸŒ Dil: $(config_get language)")
    MENU_ACTIONS+=("do_change_lang")
    
    MENU_ITEMS+=("ðŸŽ¨ Tema: $(config_get theme)")
    MENU_ACTIONS+=("do_change_theme")
    
    MENU_ITEMS+=("ðŸ“‹ Tmux Config Uygula")
    MENU_ACTIONS+=("do_apply_config")
    
    MENU_ITEMS+=("â† Geri")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    handle_menu_result
}

do_change_lang() {
    MENU_ITEMS=("ðŸŒ Auto" "ðŸ‡¬ðŸ‡§ English" "ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e" "â† Geri")
    MENU_ACTIONS=("set_lang|auto" "set_lang|en" "set_lang|tr" "do_settings")
    MENU_TITLE="ðŸŒ Dil SeÃ§imi"
    MENU_SELECTED=0
    
    menu_loop
    handle_menu_result
}

set_lang() {
    config_set language "$1"
    config_save
    lang_load "$1"
    show_message success "Dil deÄŸiÅŸtirildi"
    sleep 1
    do_settings
}

do_change_theme() {
    MENU_ITEMS=("ðŸŽ¨ Default" "ðŸ“ Minimal" "â† Geri")
    MENU_ACTIONS=("set_theme|default" "set_theme|minimal" "do_settings")
    MENU_TITLE="ðŸŽ¨ Tema SeÃ§imi"
    MENU_SELECTED=0
    
    menu_loop
    handle_menu_result
}

set_theme() {
    config_set theme "$1"
    config_save
    source "$TSM_ROOT/themes/$1.sh"
    show_message success "Tema deÄŸiÅŸtirildi"
    sleep 1
    do_settings
}

do_apply_config() {
    show_loading "Config uygulanÄ±yor..."
    
    cat > ~/.tmux.conf << 'TCFG'
# TSM Config
set -g history-limit 50000
set -g mouse on
setw -g mode-keys vi
set -sg escape-time 0
set -g base-index 1
set -g renumber-windows on

# Status bar
set -g status-style 'bg=#1e1e2e fg=#cdd6f4'
set -g status-left '#[bg=#89b4fa,fg=#1e1e2e,bold] #S #[default] '
set -g status-right ' c:New n:Next p:Prev T:TSM | %H:%M '
setw -g window-status-current-format '#[bg=#a6e3a1,fg=#1e1e2e,bold] #I:#W '

# TSM shortcut
bind-key T run-shell 'tmux detach -E tsm'

# Scroll
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind u copy-mode
TCFG
    
    tmux source-file ~/.tmux.conf 2>/dev/null
    
    clear_loading
    show_message success "Config uygulandÄ±"
    sleep 1
    do_settings
}

do_exit() {
    reset_terminal
    clear_screen
    exit 0
}

# MenÃ¼ sonucunu iÅŸle
handle_menu_result() {
    local sel=$MENU_RESULT
    
    [[ $sel -eq 255 ]] && main_menu && return
    
    if [[ $sel -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$sel]}"
        IFS='|' read -r func arg1 arg2 <<< "$action"
        [[ -n "$func" ]] && $func "$arg1" "$arg2"
    else
        main_menu
    fi
}

# Ana menÃ¼
main_menu() {
    MENU_TITLE="ðŸ–¥ï¸  TSM - Session Manager"
    MENU_SELECTED=0
    MENU_RESULT=255
    
    build_main_menu
    menu_loop
    handle_menu_result
}

# CLI
show_help() {
    cat << EOF
TSM v${TSM_VERSION}

KullanÄ±m: tsm [seÃ§enek]

  -h    YardÄ±m
  -v    Versiyon
  -l    Oturum listesi
  -n X  Yeni oturum
  -a    Son oturuma baÄŸlan

KÄ±sayollar:
  â†‘â†“    Gezin
  Enter SeÃ§
  q     Ã‡Ä±k
  
Tmux:
  Ctrl+b T  TSM aÃ§
  Ctrl+b c  Yeni pencere
  Ctrl+b d  Detach
EOF
}

# Main
main() {
    case "${1:-}" in
        -h|--help) show_help; exit 0 ;;
        -v|--version) echo "TSM v$TSM_VERSION"; exit 0 ;;
        -l|--list) sessions_list | while IFS='|' read -r n w a c; do echo "$n ($w win)"; done; exit 0 ;;
        -n|--new) [[ -n "$2" ]] && { session_create "$2"; tmux attach -t "$2"; } || echo "KullanÄ±m: tsm -n AD"; exit 0 ;;
        -a|--attach) 
            local s=$(get_last_session)
            [[ -n "$s" ]] && tmux has -t "$s" 2>/dev/null && tmux attach -t "$s" && exit 0
            s=$(tmux ls -F '#{session_name}' 2>/dev/null | head -1)
            [[ -n "$s" ]] && tmux attach -t "$s" || echo "Oturum yok"
            exit 0 ;;
    esac
    
    init
    main_menu
}

main "$@"

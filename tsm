#!/bin/bash
#
# TSM - Tmux Session Manager v2.2.0
# https://github.com/ahmedsaid47/tmux-session-manager
#

TSM_ROOT="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
export TSM_ROOT

TSM_VERSION="2.2.0"

source "$TSM_ROOT/lib/utils.sh"
source "$TSM_ROOT/lib/config.sh"
source "$TSM_ROOT/lib/lang.sh"
source "$TSM_ROOT/lib/core.sh"
source "$TSM_ROOT/lib/menu.sh"

# Initialize
init() {
    if ! check_tmux; then
        echo "Error: tmux is not installed"
        exit 1
    fi
    
    setup_cleanup
    check_terminal
    check_connection
    config_init
    
    lang_load "$(config_get language)"
    
    local theme
    theme="$(config_get theme)"
    
    if [[ "$HAS_EMOJI" == "false" ]] && [[ "$theme" == "default" ]]; then
        theme="minimal"
    fi
    
    source "$TSM_ROOT/themes/$theme.sh"
}

# Build main menu
build_session_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    
    # Son oturum
    local last_session
    last_session=$(get_last_session)
    
    if [[ -n "$last_session" ]] && tmux has-session -t "$last_session" 2>/dev/null; then
        MENU_ITEMS+=("${ICON_LIGHTNING:-‚ö°} Son Oturum: $last_session")
        MENU_ACTIONS+=("action_attach_session|$last_session")
    fi
    
    # Yeni oturum
    MENU_ITEMS+=("${ICON_NEW} ${L_NEW_SESSION}")
    MENU_ACTIONS+=("action_new_session")
    
    # Oturum listesi
    local sessions
    sessions=$(sessions_list)
    
    if [[ -n "$sessions" ]]; then
        while IFS='|' read -r name windows attached created; do
            [[ "$name" == "$last_session" ]] && continue
            
            local status_icon status_text
            if [[ "$attached" == "1" ]]; then
                status_icon="$ICON_ACTIVE"
                status_text="$L_ACTIVE"
            else
                status_icon="$ICON_DETACHED"
                status_text="$L_DETACHED"
            fi
            
            MENU_ITEMS+=("${ICON_SESSION} ${name} (${windows} win, ${status_icon})")
            MENU_ACTIONS+=("action_session_menu|$name")
        done <<< "$sessions"
    fi
    
    MENU_ITEMS+=("${ICON_SETTINGS} ${L_SETTINGS}")
    MENU_ACTIONS+=("action_settings")
    
    MENU_ITEMS+=("${ICON_EXIT} ${L_EXIT}")
    MENU_ACTIONS+=("action_exit")
}

# Session sub-menu (with windows)
action_session_menu() {
    local session_name="$1"
    
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="üìÇ $session_name"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    # Baƒülan se√ßeneƒüi
    MENU_ITEMS+=("‚ñ∂Ô∏è  Oturuma Baƒülan")
    MENU_ACTIONS+=("action_attach_session|$session_name")
    
    # Windows listesi
    local windows
    windows=$(tmux list-windows -t "$session_name" -F '#{window_index}|#{window_name}|#{window_active}' 2>/dev/null)
    
    if [[ -n "$windows" ]]; then
        MENU_ITEMS+=("‚îÄ‚îÄ‚îÄ Pencereler ‚îÄ‚îÄ‚îÄ")
        MENU_ACTIONS+=("action_session_menu|$session_name")
        
        while IFS='|' read -r idx wname active; do
            local icon="  "
            [[ "$active" == "1" ]] && icon="‚ñ∏ "
            MENU_ITEMS+=("${icon}${idx}: ${wname}")
            MENU_ACTIONS+=("action_attach_window|$session_name|$idx")
        done <<< "$windows"
    fi
    
    # Yeni window
    MENU_ITEMS+=("‚ûï Yeni Pencere")
    MENU_ACTIONS+=("action_new_window|$session_name")
    
    # Oturum i≈ülemleri
    MENU_ITEMS+=("‚úèÔ∏è  Adƒ±nƒ± Deƒüi≈ütir")
    MENU_ACTIONS+=("action_rename_session|$session_name")
    
    MENU_ITEMS+=("üóëÔ∏è  Oturumu Sil")
    MENU_ACTIONS+=("action_delete_session|$session_name")
    
    MENU_ITEMS+=("${ICON_BACK} Geri")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        main_menu
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg1 arg2 <<< "$action"
        $func "$arg1" "$arg2"
    else
        main_menu
    fi
}

# Attach to specific window
action_attach_window() {
    local session="$1"
    local window="$2"
    cursor_show
    save_last_session "$session"
    tmux select-window -t "$session:$window" 2>/dev/null
    session_attach_with_return "$session"
}

# New window in session
action_new_window() {
    local session="$1"
    local wname
    wname=$(input_dialog "Pencere adƒ±" "")
    
    if [[ -n "$wname" ]]; then
        tmux new-window -t "$session" -n "$wname"
        show_message success "Pencere olu≈üturuldu"
    else
        tmux new-window -t "$session"
        show_message success "Pencere olu≈üturuldu"
    fi
    
    action_session_menu "$session"
}

# Action: New session
action_new_session() {
    local name
    name=$(input_dialog "$L_SESSION_NAME" "")
    
    if [[ -n "$name" ]]; then
        if validate_session_name "$name"; then
            if session_create "$name"; then
                show_message success "$L_SESSION_CREATED"
                save_last_session "$name"
                session_attach_with_return "$name"
            else
                show_message error "$L_ERROR"
                main_menu
            fi
        else
            show_message error "$L_INVALID_NAME"
            main_menu
        fi
    else
        main_menu
    fi
}

# Action: Attach to session
action_attach_session() {
    local name="$1"
    cursor_show
    save_last_session "$name"
    session_attach_with_return "$name"
}

# Attach with return to TSM on detach
session_attach_with_return() {
    local name="$1"
    
    if is_in_tmux; then
        tmux switch-client -t "$name"
    else
        tmux attach-session -t "$name"
        
        if [[ -n "$SSH_CONNECTION" ]]; then
            exec tsm
        fi
    fi
}

# Action: Rename session
action_rename_session() {
    local old_name="$1"
    local new_name
    new_name=$(input_dialog "$L_NEW_NAME" "$old_name")
    
    if [[ -n "$new_name" ]] && [[ "$new_name" != "$old_name" ]]; then
        if validate_session_name "$new_name"; then
            if session_rename "$old_name" "$new_name"; then
                show_message success "$L_SESSION_RENAMED"
                if [[ "$(get_last_session)" == "$old_name" ]]; then
                    save_last_session "$new_name"
                fi
            else
                show_message error "$L_ERROR"
            fi
        else
            show_message error "$L_INVALID_NAME"
        fi
    fi
    
    main_menu
}

# Action: Delete session
action_delete_session() {
    local name="$1"
    
    if confirm_dialog "${L_CONFIRM_DELETE} '$name'"; then
        if session_delete "$name"; then
            show_message success "$L_SESSION_DELETED"
            if [[ "$(get_last_session)" == "$name" ]]; then
                save_last_session ""
            fi
        else
            show_message error "$L_ERROR"
        fi
    fi
    
    main_menu
}

# Action: Settings menu
action_settings() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_SETTINGS"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("üåç Dil: $(config_get language)")
    MENU_ACTIONS+=("action_change_language")
    
    MENU_ITEMS+=("üé® Tema: $(config_get theme)")
    MENU_ACTIONS+=("action_change_theme")
    
    MENU_ITEMS+=("‚öôÔ∏è  Tmux Config Uygula")
    MENU_ACTIONS+=("action_apply_tmux_config")
    
    MENU_ITEMS+=("${ICON_BACK} Geri")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        main_menu
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Apply tmux config
action_apply_tmux_config() {
    local tmux_conf="$HOME/.tmux.conf"
    
    cat > "$tmux_conf" << 'TMUXCFG'
# TSM - Tmux Session Manager
set -g history-limit 50000
set -g mouse on
setw -g mode-keys vi
set -sg escape-time 0
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Status Bar - Kƒ±sayollar g√∂ster
set -g status-position bottom
set -g status-style 'bg=#1e1e2e fg=#cdd6f4'
set -g status-left '#[bg=#89b4fa,fg=#1e1e2e,bold] #S #[default] '
set -g status-left-length 20
set -g status-right ' #[fg=#6c7086]c:New n:Next p:Prev T:TSM d:Detach #[fg=#89b4fa]| #[fg=white]%H:%M '
set -g status-right-length 60

# Window format
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format '#[bg=#a6e3a1,fg=#1e1e2e,bold] #I:#W '

# TSM binding
bind-key T run-shell 'tmux detach-client -E "tsm"'

# Scroll
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M
bind u copy-mode

# Window shortcuts
bind c new-window -c "#{pane_current_path}"
TMUXCFG
    
    tmux source-file "$tmux_conf" 2>/dev/null || true
    
    show_message success "Config uygulandƒ±! Yeni oturumda aktif."
    action_settings
}

# Action: Change language
action_change_language() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="Dil Se√ßimi"
    MENU_SELECTED=0
    
    MENU_ITEMS+=("üåê Auto (Sistem)")
    MENU_ACTIONS+=("set_language|auto")
    
    MENU_ITEMS+=("üá¨üáß English")
    MENU_ACTIONS+=("set_language|en")
    
    MENU_ITEMS+=("üáπüá∑ T√ºrk√ße")
    MENU_ACTIONS+=("set_language|tr")
    
    MENU_ITEMS+=("${ICON_BACK} Geri")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        action_settings
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    fi
}

set_language() {
    config_set language "$1"
    config_save
    lang_load "$1"
    show_message success "Dil deƒüi≈ütirildi"
    action_settings
}

# Action: Change theme
action_change_theme() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="Tema Se√ßimi"
    MENU_SELECTED=0
    
    MENU_ITEMS+=("üé® Default (Emoji)")
    MENU_ACTIONS+=("set_theme|default")
    
    MENU_ITEMS+=("üìù Minimal (ASCII)")
    MENU_ACTIONS+=("set_theme|minimal")
    
    MENU_ITEMS+=("${ICON_BACK} Geri")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        action_settings
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    fi
}

set_theme() {
    config_set theme "$1"
    config_save
    source "$TSM_ROOT/themes/$1.sh"
    show_message success "Tema deƒüi≈ütirildi"
    action_settings
}

# Action: Exit
action_exit() {
    cursor_show
    clear_screen
    exit 0
}

# Main menu
main_menu() {
    MENU_TITLE="üñ•Ô∏è  TMUX SESSION MANAGER"
    MENU_SELECTED=0
    MENU_FILTER=""
    MENU_RESULT=255
    
    build_session_menu
    
    menu_loop
    local selected=$MENU_RESULT
    
    case $selected in
        255) action_exit ;;
        254) action_new_session ;;
        *)
            if [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
                local action="${MENU_ACTIONS[$selected]}"
                IFS='|' read -r func arg <<< "$action"
                [[ -n "$func" ]] && $func "$arg"
            fi
            ;;
    esac
}

# CLI functions
show_version() {
    echo "TSM - Tmux Session Manager v${TSM_VERSION}"
}

show_usage() {
    cat << EOF
TSM v${TSM_VERSION} - Tmux Session Manager

Kullanƒ±m: tsm [se√ßenek]

Se√ßenekler:
  -h, --help      Yardƒ±m
  -v, --version   Versiyon
  -l, --list      Oturum listesi
  -n, --new AD    Yeni oturum
  -a, --attach    Son oturuma baƒülan

Men√º Kƒ±sayollarƒ±:
  ‚Üë/‚Üì       Gezin
  Enter     Se√ß
  n         Yeni oturum
  q/Esc     √áƒ±k

Tmux Kƒ±sayollarƒ±:
  Ctrl+b T  TSM men√ºs√º
  Ctrl+b c  Yeni pencere
  Ctrl+b n  Sonraki pencere
  Ctrl+b p  √ñnceki pencere
  Ctrl+b d  Detach
EOF
}

list_sessions_cli() {
    local sessions
    sessions=$(sessions_list)
    [[ -z "$sessions" ]] && echo "Oturum yok" && return
    
    while IFS='|' read -r name windows attached created; do
        local s="detached"
        [[ "$attached" == "1" ]] && s="attached"
        echo "$name: $windows pencere ($s)"
    done <<< "$sessions"
}

# Main
main() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help) show_usage; exit 0 ;;
            -v|--version) show_version; exit 0 ;;
            -l|--list) list_sessions_cli; exit 0 ;;
            -n|--new)
                [[ -n "${2:-}" ]] || { echo "Kullanƒ±m: tsm -n AD"; exit 1; }
                session_create "$2"; session_attach "$2"; exit 0 ;;
            -a|--attach)
                local last=$(get_last_session)
                [[ -n "$last" ]] && tmux has-session -t "$last" 2>/dev/null && session_attach "$last" && exit 0
                last=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | head -1)
                [[ -n "$last" ]] && session_attach "$last" || echo "Oturum yok"
                exit 0 ;;
            *) echo "Bilinmeyen: $1"; show_usage; exit 1 ;;
        esac
        shift
    done
    
    init
    main_menu
}

main "$@"

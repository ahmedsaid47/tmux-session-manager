#!/bin/bash
#
# TSM - Tmux Session Manager
# https://github.com/ahmedsaid47/tmux-session-manager
#
# Interactive tmux session manager with arrow key navigation
#

set -e

# Get script directory
TSM_ROOT="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
export TSM_ROOT

# Version
TSM_VERSION="2.0.0"

# Load libraries
source "$TSM_ROOT/lib/utils.sh"
source "$TSM_ROOT/lib/config.sh"
source "$TSM_ROOT/lib/lang.sh"
source "$TSM_ROOT/lib/core.sh"
source "$TSM_ROOT/lib/menu.sh"

# Initialize
init() {
    # Check tmux
    if ! check_tmux; then
        echo "Error: tmux is not installed"
        exit 1
    fi
    
    # Setup cleanup
    setup_cleanup
    
    # Check terminal
    check_terminal
    check_connection
    
    # Initialize config
    config_init
    
    # Load language
    lang_load "$(config_get language)"
    
    # Load theme
    local theme="$(config_get theme)"
    
    # Auto-select minimal theme for poor terminals
    if [[ "$HAS_EMOJI" == "false" ]] && [[ "$theme" == "default" ]]; then
        theme="minimal"
    fi
    
    source "$TSM_ROOT/themes/$theme.sh"
}

# Build session menu items
build_session_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    
    # New session option
    MENU_ITEMS+=("${ICON_NEW} ${L_NEW_SESSION}")
    MENU_ACTIONS+=("action_new_session")
    
    # List sessions
    local sessions
    sessions=$(sessions_list)
    
    if [[ -n "$sessions" ]]; then
        while IFS='|' read -r name windows attached created; do
            local status_icon
            [[ "$attached" == "1" ]] && status_icon="$ICON_ACTIVE" || status_icon="$ICON_DETACHED"
            
            local status_text
            [[ "$attached" == "1" ]] && status_text="$L_ACTIVE" || status_text="$L_DETACHED"
            
            MENU_ITEMS+=("${ICON_SESSION} ${name} (${windows} ${L_WINDOWS_COUNT}, ${status_icon} ${status_text})")
            MENU_ACTIONS+=("action_attach_session|$name")
        done <<< "$sessions"
    fi
    
    # Other options
    if [[ -n "$sessions" ]]; then
        MENU_ITEMS+=("${ICON_RENAME} ${L_RENAME_SESSION}")
        MENU_ACTIONS+=("action_rename_menu")
        
        MENU_ITEMS+=("${ICON_DELETE} ${L_DELETE_SESSION}")
        MENU_ACTIONS+=("action_delete_menu")
    fi
    
    MENU_ITEMS+=("${ICON_SETTINGS} ${L_SETTINGS}")
    MENU_ACTIONS+=("action_settings")
    
    MENU_ITEMS+=("${ICON_EXIT} ${L_EXIT}")
    MENU_ACTIONS+=("action_exit")
}

# Action: New session
action_new_session() {
    local name
    name=$(input_dialog "$L_SESSION_NAME" "$(config_get default_session)")
    
    if [[ -n "$name" ]]; then
        if validate_session_name "$name"; then
            if session_create "$name"; then
                return 0
            else
                show_message error "$L_ERROR: Session already exists"
            fi
        else
            show_message error "$L_INVALID_NAME"
        fi
    fi
    
    main_menu
}

# Action: Attach to session
action_attach_session() {
    local name="$1"
    session_attach "$name"
}

# Action: Rename menu
action_rename_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_RENAME_SESSION"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    local sessions
    sessions=$(sessions_list)
    
    while IFS='|' read -r name windows attached created; do
        MENU_ITEMS+=("${ICON_RENAME} ${name}")
        MENU_ACTIONS+=("action_rename_session|$name")
    done <<< "$sessions"
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Rename session
action_rename_session() {
    local old_name="$1"
    local new_name
    new_name=$(input_dialog "$L_NEW_NAME" "$old_name")
    
    if [[ -n "$new_name" ]] && [[ "$new_name" != "$old_name" ]]; then
        if validate_session_name "$new_name"; then
            if session_rename "$old_name" "$new_name"; then
                show_message success "$L_SESSION_RENAMED"
            else
                show_message error "$L_ERROR"
            fi
        else
            show_message error "$L_INVALID_NAME"
        fi
    fi
    
    main_menu
}

# Action: Delete menu
action_delete_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_DELETE_SESSION"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    local sessions
    sessions=$(sessions_list)
    
    while IFS='|' read -r name windows attached created; do
        MENU_ITEMS+=("${ICON_DELETE} ${name}")
        MENU_ACTIONS+=("action_delete_session|$name")
    done <<< "$sessions"
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Delete session
action_delete_session() {
    local name="$1"
    
    if confirm_dialog "${L_CONFIRM_DELETE} '$name'"; then
        if session_delete "$name"; then
            show_message success "$L_SESSION_DELETED"
        else
            show_message error "$L_ERROR"
        fi
    fi
    
    # Check if any sessions left
    if [[ $(sessions_count) -eq 0 ]]; then
        main_menu
    else
        action_delete_menu
    fi
}

# Action: Settings
action_settings() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_SETTINGS_TITLE"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    # Language
    local current_lang="$(config_get language)"
    local lang_display
    [[ "$current_lang" == "auto" ]] && lang_display="Auto" || lang_display="$(lang_get_name "$current_lang")"
    MENU_ITEMS+=("${L_LANGUAGE}: ${lang_display}")
    MENU_ACTIONS+=("action_change_language")
    
    # Theme
    local current_theme="$(config_get theme)"
    MENU_ITEMS+=("${L_THEME}: ${current_theme}")
    MENU_ACTIONS+=("action_change_theme")
    
    # Auto-attach
    local auto_attach="$(config_get auto_attach)"
    local auto_attach_status
    [[ "$auto_attach" == "true" ]] && auto_attach_status="✓" || auto_attach_status="✗"
    MENU_ITEMS+=("${L_AUTO_ATTACH}: ${auto_attach_status}")
    MENU_ACTIONS+=("action_toggle_auto_attach")
    
    # Show preview
    local show_preview="$(config_get show_preview)"
    local preview_status
    [[ "$show_preview" == "true" ]] && preview_status="✓" || preview_status="✗"
    MENU_ITEMS+=("${L_SHOW_PREVIEW}: ${preview_status}")
    MENU_ACTIONS+=("action_toggle_preview")
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        $action
    else
        main_menu
    fi
}

# Action: Change language
action_change_language() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_LANGUAGE"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("Auto (System)")
    MENU_ACTIONS+=("set_language|auto")
    
    for lang in $(lang_list); do
        MENU_ITEMS+=("$(lang_get_name "$lang")")
        MENU_ACTIONS+=("set_language|$lang")
    done
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        action_settings
    fi
}

set_language() {
    local lang="$1"
    config_set language "$lang"
    config_save
    lang_load "$lang"
    action_settings
}

# Action: Change theme
action_change_theme() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_THEME"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("Default (Modern)")
    MENU_ACTIONS+=("set_theme|default")
    
    MENU_ITEMS+=("Minimal (ASCII)")
    MENU_ACTIONS+=("set_theme|minimal")
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        action_settings
    fi
}

set_theme() {
    local theme="$1"
    config_set theme "$theme"
    config_save
    source "$TSM_ROOT/themes/$theme.sh"
    action_settings
}

# Action: Toggle auto-attach
action_toggle_auto_attach() {
    local current="$(config_get auto_attach)"
    if [[ "$current" == "true" ]]; then
        config_set auto_attach "false"
    else
        config_set auto_attach "true"
    fi
    config_save
    action_settings
}

# Action: Toggle preview
action_toggle_preview() {
    local current="$(config_get show_preview)"
    if [[ "$current" == "true" ]]; then
        config_set show_preview "false"
    else
        config_set show_preview "true"
    fi
    config_save
    action_settings
}

# Action: Exit
action_exit() {
    clear_screen
    echo -e "${C_SUCCESS}${L_GOODBYE}${C_RESET}"
    exit 0
}

# Main menu
main_menu() {
    MENU_TITLE="$L_TITLE"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    build_session_menu
    
    menu_loop
    local selected=$?
    
    if [[ $selected -ne 255 ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        action_exit
    fi
}

# Show version
show_version() {
    echo "TSM - Tmux Session Manager v${TSM_VERSION}"
    echo "https://github.com/ahmedsaid47/tmux-session-manager"
}

# Show help
show_usage() {
    cat << EOF
TSM - Tmux Session Manager v${TSM_VERSION}

Usage: tsm [options]

Options:
  -h, --help      Show this help message
  -v, --version   Show version
  -l, --list      List all sessions
  -n, --new NAME  Create new session
  -a, --attach    Attach to last session

Without options, starts interactive menu.

https://github.com/ahmedsaid47/tmux-session-manager
EOF
}

# Parse arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_usage
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -l|--list)
                tmux list-sessions 2>/dev/null || echo "No sessions"
                exit 0
                ;;
            -n|--new)
                shift
                session_create "${1:-$(config_get default_session)}"
                exit 0
                ;;
            -a|--attach)
                local last=$(session_last)
                if [[ -n "$last" ]]; then
                    session_attach "$last"
                else
                    echo "No sessions to attach"
                fi
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
        shift
    done
}

# Main entry point
main() {
    # Parse command line arguments
    if [[ $# -gt 0 ]]; then
        parse_args "$@"
    fi
    
    # Initialize
    init
    
    # Check for auto-attach
    if [[ "$(config_get auto_attach)" == "true" ]]; then
        local last=$(session_last)
        if [[ -n "$last" ]] && ! is_in_tmux; then
            session_attach "$last"
            exit 0
        fi
    fi
    
    # Start interactive menu
    main_menu
}

# Run
main "$@"

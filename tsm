#!/bin/bash
#
# TSM - Tmux Session Manager
# https://github.com/ahmedsaid47/tmux-session-manager
#
# Interactive tmux session manager with arrow key navigation
#

# Disable set -e for safe menu handling
# set -e

# Get script directory
TSM_ROOT="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
export TSM_ROOT

# Version
TSM_VERSION="2.0.0"

# Load libraries
source "$TSM_ROOT/lib/utils.sh"
source "$TSM_ROOT/lib/config.sh"
source "$TSM_ROOT/lib/lang.sh"
source "$TSM_ROOT/lib/core.sh"
source "$TSM_ROOT/lib/menu.sh"

# Initialize
init() {
    if ! check_tmux; then
        echo "Error: tmux is not installed"
        exit 1
    fi
    
    setup_cleanup
    check_terminal
    check_connection
    config_init
    
    lang_load "$(config_get language)"
    
    local theme
    theme="$(config_get theme)"
    
    if [[ "$HAS_EMOJI" == "false" ]] && [[ "$theme" == "default" ]]; then
        theme="minimal"
    fi
    
    source "$TSM_ROOT/themes/$theme.sh"
}

# Build session menu items
build_session_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    
    MENU_ITEMS+=("${ICON_NEW} ${L_NEW_SESSION}")
    MENU_ACTIONS+=("action_new_session")
    
    local sessions
    sessions=$(sessions_list)
    
    if [[ -n "$sessions" ]]; then
        while IFS='|' read -r name windows attached created; do
            local status_icon status_text
            if [[ "$attached" == "1" ]]; then
                status_icon="$ICON_ACTIVE"
                status_text="$L_ACTIVE"
            else
                status_icon="$ICON_DETACHED"
                status_text="$L_DETACHED"
            fi
            
            MENU_ITEMS+=("${ICON_SESSION} ${name} (${windows} ${L_WINDOWS_COUNT}, ${status_icon} ${status_text})")
            MENU_ACTIONS+=("action_attach_session|$name")
        done <<< "$sessions"
        
        MENU_ITEMS+=("${ICON_RENAME} ${L_RENAME_SESSION}")
        MENU_ACTIONS+=("action_rename_menu")
        
        MENU_ITEMS+=("${ICON_DELETE} ${L_DELETE_SESSION}")
        MENU_ACTIONS+=("action_delete_menu")
    fi
    
    MENU_ITEMS+=("${ICON_SETTINGS} ${L_SETTINGS}")
    MENU_ACTIONS+=("action_settings")
    
    MENU_ITEMS+=("${ICON_EXIT} ${L_EXIT}")
    MENU_ACTIONS+=("action_exit")
}

# Action: New session
action_new_session() {
    local name
    name=$(input_dialog "$L_SESSION_NAME" "")
    
    if [[ -n "$name" ]]; then
        if validate_session_name "$name"; then
            if session_create "$name"; then
                show_message success "$L_SESSION_CREATED"
                session_attach "$name"
            else
                show_message error "$L_ERROR"
                main_menu
            fi
        else
            show_message error "$L_INVALID_NAME"
            main_menu
        fi
    else
        main_menu
    fi
}

# Action: Attach to session
action_attach_session() {
    local name="$1"
    cursor_show
    session_attach "$name"
}

# Action: Rename menu
action_rename_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_RENAME_SESSION"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    local sessions
    sessions=$(sessions_list)
    
    while IFS='|' read -r name windows attached created; do
        MENU_ITEMS+=("${ICON_RENAME} ${name}")
        MENU_ACTIONS+=("action_rename_session|$name")
    done <<< "$sessions"
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        main_menu
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Rename session
action_rename_session() {
    local old_name="$1"
    local new_name
    new_name=$(input_dialog "$L_NEW_NAME" "$old_name")
    
    if [[ -n "$new_name" ]] && [[ "$new_name" != "$old_name" ]]; then
        if validate_session_name "$new_name"; then
            if session_rename "$old_name" "$new_name"; then
                show_message success "$L_SESSION_RENAMED"
            else
                show_message error "$L_ERROR"
            fi
        else
            show_message error "$L_INVALID_NAME"
        fi
    fi
    
    main_menu
}

# Action: Delete menu
action_delete_menu() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_DELETE_SESSION"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    local sessions
    sessions=$(sessions_list)
    
    while IFS='|' read -r name windows attached created; do
        MENU_ITEMS+=("${ICON_DELETE} ${name}")
        MENU_ACTIONS+=("action_delete_session|$name")
    done <<< "$sessions"
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        main_menu
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Delete session
action_delete_session() {
    local name="$1"
    
    if confirm_dialog "${L_CONFIRM_DELETE} '$name'"; then
        if session_delete "$name"; then
            show_message success "$L_SESSION_DELETED"
        else
            show_message error "$L_ERROR"
        fi
    fi
    
    main_menu
}

# Action: Settings menu
action_settings() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_SETTINGS"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("${ICON_SETTINGS} ${L_LANGUAGE}: $(config_get language)")
    MENU_ACTIONS+=("action_change_language")
    
    MENU_ITEMS+=("${ICON_SETTINGS} ${L_THEME}: $(config_get theme)")
    MENU_ACTIONS+=("action_change_theme")
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("main_menu")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        main_menu
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        main_menu
    fi
}

# Action: Change language
action_change_language() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_LANGUAGE"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("Auto (System)")
    MENU_ACTIONS+=("set_language|auto")
    
    MENU_ITEMS+=("English")
    MENU_ACTIONS+=("set_language|en")
    
    MENU_ITEMS+=("TÃ¼rkÃ§e")
    MENU_ACTIONS+=("set_language|tr")
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        action_settings
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        action_settings
    fi
}

# Set language
set_language() {
    local lang="$1"
    config_set language "$lang"
    config_save
    lang_load "$lang"
    show_message success "$L_SETTINGS_SAVED"
    action_settings
}

# Action: Change theme
action_change_theme() {
    MENU_ITEMS=()
    MENU_ACTIONS=()
    MENU_TITLE="$L_THEME"
    MENU_SELECTED=0
    MENU_FILTER=""
    
    MENU_ITEMS+=("ðŸŽ¨ Default (Modern)")
    MENU_ACTIONS+=("set_theme|default")
    
    MENU_ITEMS+=("ðŸ“ Minimal (ASCII)")
    MENU_ACTIONS+=("set_theme|minimal")
    
    MENU_ITEMS+=("${ICON_BACK} ${L_BACK}")
    MENU_ACTIONS+=("action_settings")
    
    menu_loop
    local selected=$MENU_RESULT
    
    if [[ $selected -eq 255 ]]; then
        action_settings
    elif [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
        local action="${MENU_ACTIONS[$selected]}"
        IFS='|' read -r func arg <<< "$action"
        $func "$arg"
    else
        action_settings
    fi
}

# Set theme
set_theme() {
    local theme="$1"
    config_set theme "$theme"
    config_save
    source "$TSM_ROOT/themes/$theme.sh"
    show_message success "$L_SETTINGS_SAVED"
    action_settings
}

# Action: Exit
action_exit() {
    cursor_show
    clear_screen
    exit 0
}

# Main menu
main_menu() {
    MENU_TITLE="$L_TITLE"
    MENU_SELECTED=0
    MENU_FILTER=""
    MENU_RESULT=255
    
    build_session_menu
    
    menu_loop
    local selected=$MENU_RESULT
    
    case $selected in
        255)
            action_exit
            ;;
        254)
            action_new_session
            ;;
        253)
            action_delete_menu
            ;;
        252)
            action_rename_menu
            ;;
        *)
            if [[ $selected -lt ${#MENU_ACTIONS[@]} ]]; then
                local action="${MENU_ACTIONS[$selected]}"
                IFS='|' read -r func arg <<< "$action"
                if [[ -n "$func" ]]; then
                    $func "$arg"
                fi
            fi
            ;;
    esac
}

# Show version
show_version() {
    echo "TSM - Tmux Session Manager v${TSM_VERSION}"
    echo "https://github.com/ahmedsaid47/tmux-session-manager"
}

# Show help
show_usage() {
    cat << EOF
TSM - Tmux Session Manager v${TSM_VERSION}

Usage: tsm [options]

Options:
  -h, --help      Show this help message
  -v, --version   Show version
  -l, --list      List all sessions
  -n, --new NAME  Create new session
  -a, --attach    Attach to last session

Without options, starts interactive menu.

https://github.com/ahmedsaid47/tmux-session-manager
EOF
}

# List sessions CLI
list_sessions_cli() {
    local sessions
    sessions=$(sessions_list)
    
    if [[ -z "$sessions" ]]; then
        echo "No sessions found"
        return
    fi
    
    while IFS='|' read -r name windows attached created; do
        local status
        if [[ "$attached" == "1" ]]; then
            status="(attached)"
        else
            status="(detached)"
        fi
        echo "$name: $windows windows $status"
    done <<< "$sessions"
}

# Main function
main() {
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_usage
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -l|--list)
                check_tmux || { echo "tmux not found"; exit 1; }
                list_sessions_cli
                exit 0
                ;;
            -n|--new)
                check_tmux || { echo "tmux not found"; exit 1; }
                if [[ -n "${2:-}" ]]; then
                    session_create "$2"
                    session_attach "$2"
                else
                    echo "Usage: tsm -n SESSION_NAME"
                    exit 1
                fi
                exit 0
                ;;
            -a|--attach)
                check_tmux || { echo "tmux not found"; exit 1; }
                local last
                last=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | head -1)
                if [[ -n "$last" ]]; then
                    session_attach "$last"
                else
                    echo "No sessions found"
                fi
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
        shift
    done
    
    # Initialize and run
    init
    main_menu
}

# Run
main "$@"
